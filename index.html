<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Electrical Works Quote Template</title>
    <style>
        body {
            font-family: 'Times New Roman', serif;
            margin: 20px;
            background: white;
            color: #000;
            line-height: 1.4;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #000;
            padding-bottom: 15px;
        }
        .header h1 {
            font-size: 24px;
            font-weight: bold;
            margin: 0;
            text-decoration: underline;
        }
        .save-load-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #000;
            background: #f9f9f9;
            text-align: center;
        }
        .save-load-section h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            text-transform: uppercase;
        }
        .section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }
        .section-header {
            font-weight: bold;
            font-size: 14px;
            text-decoration: underline;
            margin-bottom: 10px;
            text-transform: uppercase;
        }
        .section-content {
            margin-left: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #000;
            padding: 6px;
            text-align: left;
            vertical-align: middle;
            min-height: 28px;
            height: 28px;
        }
        th {
            background-color: #f0f0f0;
            font-weight: bold;
        }
        .input-field {
            width: 100%;
            padding: 4px;
            border: none;
            border-bottom: 1px solid #000;
            background: transparent;
            font-size: 12px;
            font-family: inherit;
        }
        .input-field:focus {
            outline: none;
            background: #f9f9f9;
        }
        
        /* Style for readonly/calculated fields */
        .readonly-field {
            width: 100%;
            padding: 4px;
            border: none;
            background: transparent !important;
            font-size: 12px;
            font-family: inherit;
            pointer-events: none;
            -moz-appearance: textfield; /* Firefox */
        }
        
        /* Remove number input arrows */
        .readonly-field::-webkit-outer-spin-button,
        .readonly-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Remove underlines only for table inputs */
        table .input-field {
            border-bottom: none;
        }
        .expanding-field {
            width: 100%;
            padding: 2px;
            border: none;
            background: transparent;
            font-size: 12px;
            font-family: inherit;
            resize: none;
            overflow: hidden;
            min-height: 18px;
            height: 18px;
            line-height: 1.2;
        }
        .expanding-field:focus {
            outline: none;
            background: #f9f9f9;
        }
        
        .checkbox-field {
            margin: 0;
            transform: scale(1.2);
            accent-color: #000;
        }
        
        /* Print-friendly checkbox - alternative approach */
        .checkbox-field:checked::after {
            content: "✓";
            position: absolute;
            font-weight: bold;
            color: #000;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .three-column {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .full-width {
            grid-column: 1 / -1;
        }
        .add-button {
            background: #000;
            color: white;
            border: none;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 8px;
        }
        .add-button:hover {
            background: #333;
        }
        .total-section {
            border: 2px solid #000;
            padding: 15px;
            margin-top: 20px;
            background: #f9f9f9;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }
        .final-total {
            font-size: 16px;
            font-weight: bold;
            border-top: 2px solid #000;
            padding-top: 10px;
            margin-top: 10px;
        }
        .notes-area {
            width: 100%;
            min-height: 80px;
            padding: 8px;
            border: 1px solid #000;
            background: transparent;
            resize: vertical;
            font-family: inherit;
            font-size: 12px;
        }
        .notes-area:focus {
            outline: none;
            background: #f9f9f9;
        }
        .action-button {
            background: #000;
            color: white;
            padding: 10px 20px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            margin: 15px 10px 20px 0;
        }
        .action-button:hover {
            background: #333;
        }
        .action-button.secondary {
            background: #666;
        }
        .action-button.secondary:hover {
            background: #888;
        }
        .job-name {
            border: 2px solid #000;
            padding: 15px;
            margin-bottom: 20px;
            background: #f9f9f9;
        }
        .job-name label {
            font-weight: bold;
            font-size: 14px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            font-size: 12px;
            height: 100%;
        }
        .field-group {
            margin-bottom: 12px;
        }
        .field-group label {
            font-weight: bold;
            display: block;
            margin-bottom: 3px;
            font-size: 12px;
        }
        .subtotal-line {
            text-align: right;
            font-weight: bold;
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid #000;
        }
        
        #fileInput {
            display: none;
        }
        
        @media print {
            body { 
                background: white !important;
                font-size: 11px;
            }
            .action-button, .add-button, .save-load-section { 
                display: none !important; 
            }
            .container { 
                margin: 0;
                padding: 10px;
            }
            .section {
                page-break-inside: avoid;
            }
            .input-field {
                background: transparent !important;
            }
            
            table .input-field {
                border: none !important;
            }
            table {
                font-size: 10px;
            }
            .total-section {
                page-break-inside: avoid;
            }
            
            /* Force checkbox visibility in print - more aggressive approach */
            .checkbox-field {
                -webkit-appearance: none !important;
                appearance: none !important;
                width: 18px !important;
                height: 18px !important;
                border: 2px solid #000 !important;
                background: white !important;
                position: relative !important;
                transform: none !important;
                margin: 0 !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            .checkbox-field:checked {
                background: #000 !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            .checkbox-field:checked::after {
                content: "✓" !important;
                position: absolute !important;
                top: -2px !important;
                left: 2px !important;
                color: white !important;
                font-size: 14px !important;
                font-weight: bold !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            .input-field {
                background: transparent !important;
            }
            
            /* Ensure readonly fields remain clean in print */
            .readonly-field {
                background: transparent !important;
                border: none !important;
                -webkit-appearance: none !important;
                -moz-appearance: textfield !important;
                pointer-events: none !important;
            }
            
            .readonly-field::-webkit-outer-spin-button,
            .readonly-field::-webkit-inner-spin-button {
                -webkit-appearance: none !important;
                margin: 0 !important;
            }
            
            /* Keep underlines only for specific sections in print */
            .section-content .input-field {
                border-bottom: none !important;
            }
            
            /* Add underlines back for client and site details sections */
            .section:nth-child(3) .section-content .input-field,
            .section:nth-child(4) .section-content .input-field,
            .section:nth-child(5) .section-content .input-field {
                border-bottom: 1px solid #000 !important;
            }
            
            /* Remove underlines for table inputs in print */
            table .input-field {
                border: none !important;
            }
            
            /* Ensure table headers remain grey in print */
            th {
                background-color: #f0f0f0 !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
        

            /* Force textarea expansion in print */
            textarea, .notes-area, .expanding-field {
                height: auto !important;
                min-height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                resize: none !important;
                white-space: pre-wrap !important;
                word-wrap: break-word !important;
                border: 1px solid #000 !important;
                padding: 8px !important;
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
                box-sizing: border-box !important;
            }
            
            /* Force sections with large text areas to start on new page */
            .textarea-page-break {
                page-break-before: always !important;
                margin-top: 0 !important;
            }

            /* Keep small sections together */
            .keep-together {
                page-break-inside: avoid !important;
            }
            
             /* Ensure sections don't break awkwardly */
            .section {
                orphans: 3;
                widows: 3;
            }
            
            /* Force page break before large content blocks */
            .section:has(textarea[style*="height"]) {
                page-break-inside: avoid !important;
            }
        }

        @media print {
            textarea, .notes-area, .expanding-field {
                height: auto !important;
                min-height: auto !important;
                max-height: none !important;
                overflow: visible !important;
                resize: none !important;
            }
            .section {
                page-break-inside: auto !important;
            }
        }

    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CINC Whelan Electrical</h1>
            <p style="margin: 5px 0; font-style: italic;">Small Job Scope</p>
        </div>

        <!-- Save/Load Section -->
        <div class="save-load-section">
            <h3>Save & Load Quote</h3>
            <button class="action-button secondary" onclick="saveQuote()">Save Quote</button>
            <button class="action-button secondary" onclick="document.getElementById('fileInput').click()">Load Quote</button>
            <input type="file" id="fileInput" accept=".json" onchange="loadQuote(event)">
            <p style="margin: 10px 0 0 0; font-size: 11px; color: #666;">
                Save your quote as a JSON file to continue later
            </p>
        </div>

        <!-- Job Name -->
        <div class="job-name">
            <label>Job Name:</label>
            <input type="text" class="input-field" id="jobName" placeholder="Enter job/project name" style="margin-top: 8px; font-weight: bold;">
        </div>

        <!-- Client Details -->
        <div class="section">
            <div class="section-header">Client Details</div>
            <div class="section-content">
                <div class="two-column">
                    <div class="field-group">
                        <label>Contact Person:</label>
                        <input type="text" class="input-field" id="contactPerson" placeholder="Contact">
                    </div>
                    <div class="field-group">
                        <label>Phone:</label>
                        <input type="tel" class="input-field" id="phone" placeholder="Phone">
                    </div>
                    <div class="field-group">
                        <label>Email:</label>
                        <input type="email" class="input-field" id="email" placeholder="Email">
                    </div>
                    <div class="field-group">
                        <label>Quote Due Date:</label>
                        <input type="date" class="input-field" id="quoteDueDate">
                    </div>
                </div>
                <div class="field-group">
                    <label>Business/Company Name:</label>
                    <input type="text" class="input-field" id="businessName" placeholder="Company">
                </div>
                <div class="field-group">
                    <label>Business Address:</label>
                    <div class="three-column" style="margin-top: 8px;">
                        <input type="text" class="input-field" id="businessStreet" placeholder="Street address">
                        <input type="text" class="input-field" id="businessSuburb" placeholder="Suburb/Town">
                        <input type="text" class="input-field" id="businessState" placeholder="State">
                    </div>
                    <div class="two-column" style="margin-top: 8px;">
                        <input type="text" class="input-field" id="businessPostcode" placeholder="Postcode">
                        <input type="text" class="input-field" id="businessCountry" placeholder="Country" value="Australia">
                    </div>
                </div>
            </div>
        </div>

        <!-- Site Details -->
        <div class="section">
            <div class="section-header">Site Details</div>
            <div class="section-content">
                <div class="field-group">
                    <label>Site Address:</label>
                    <div class="three-column" style="margin-top: 8px;">
                        <input type="text" class="input-field" id="siteStreet" placeholder="Street address">
                        <input type="text" class="input-field" id="siteSuburb" placeholder="Suburb/Town">
                        <input type="text" class="input-field" id="siteState" placeholder="State">
                    </div>
                    <div class="two-column" style="margin-top: 8px;">
                        <input type="text" class="input-field" id="sitePostcode" placeholder="Postcode">
                        <input type="text" class="input-field" id="siteCountry" placeholder="Country" value="Australia">
                    </div>
                </div>
            </div>
        </div>

        <!-- Scope -->
        <div class="section">
            <div class="section-header">Scope of Work</div>
            <div class="section-content">
                <textarea class="notes-area" id="scopeOfWork" placeholder="Describe the scope of electrical work to be performed..." oninput="autoExpand(this)"></textarea>
            </div>
        </div>

        <!-- Items -->
        <div class="section">
            <div class="section-header">Items & Materials</div>
            <div class="section-content">
                <table id="itemsTable">
                    <thead>
                        <tr>
                            <th style="width: 40%">Description</th>
                            <th style="width: 10%">Qty</th>
                            <th style="width: 15%">Unit Price</th>
                            <th style="width: 4%">Markup Inc.</th>
                            <th style="width: 4%">GST Inc.</th>
                            <th style="width: 23%">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="input-field" placeholder="Item description"></td>
                            <td><input type="number" class="input-field" placeholder="1" min="0" onchange="calculateItemTotal(this)"></td>
                            <td><input type="number" class="input-field" step="0.01" placeholder="0.00" onchange="calculateItemTotal(this)"></td>
                            <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                            <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                            <td><input type="number" class="readonly-field" step="0.01" placeholder="0.00" readonly></td>
                        </tr>
                    </tbody>
                </table>
                <button class="add-button" onclick="addItemRow()">+ Add Item</button>
                <div class="subtotal-line">
                    Materials Subtotal: $<span id="itemsSubtotal">0.00</span>
                </div>
            </div>
        </div>

        <!-- Labour -->
        <div class="section">
            <div class="section-header">Labour</div>
            <div class="section-content">
                <div class="two-column" style="margin-bottom: 15px;">
                    <div class="field-group">
                        <label>Normal Hour Rate ($):</label>
                        <input type="number" class="input-field" id="normalRate" value="75" step="0.01" onchange="calculateLabourTotals()" placeholder="75.00">
                    </div>
                    <div class="field-group">
                        <label>Overtime Hour Rate ($):</label>
                        <input type="number" class="input-field" id="overtimeRate" value="150" step="0.01" onchange="calculateLabourTotals()" placeholder="150.00">
                    </div>
                </div>
                <table id="labourTable">
                    <thead>
                        <tr>
                            <th style="width: 35%">Description</th>
                            <th style="width: 15%">Hours</th>
                            <th style="width: 10%">Overtime</th>
                            <th style="width: 40%">Notes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="input-field" placeholder="Labour description"></td>
                            <td><input type="number" class="input-field" step="0.5" placeholder="0.0" onchange="calculateLabourTotals()"></td>
                            <td style="text-align: center;">
                                <input type="checkbox" class="checkbox-field" onchange="calculateLabourTotals()">
                            </td>
                            <td><textarea class="expanding-field" placeholder="" oninput="autoExpand(this)"></textarea></td>
                        </tr>
                    </tbody>
                </table>
                <button class="add-button" onclick="addLabourRow()">+ Add Labour</button>
                <div class="subtotal-line">
                    Total Hours: <span id="totalHours">0.0</span> hrs
                </div>
                <div class="subtotal-line">
                    Normal Hours: <span id="normalHours">0.0</span> hrs ($<span id="normalCost">0.00</span>)
                </div>
                <div class="subtotal-line">
                    Overtime Hours: <span id="overtimeHours">0.0</span> hrs ($<span id="overtimeCost">0.00</span>)
                </div>
                <div class="subtotal-line">
                    Labour Cost: $<span id="labourSubtotal">0.00</span>
                </div>
            </div>
        </div>

        <!-- Prices Discussed -->
        <div class="section">
            <div class="section-header">Notes on Labour and Equipment</div>
            <div class="section-content">
                <textarea class="notes-area" id="pricesDiscussed" placeholder="Notes on suppliers and any specific pricing discussions, negotiations, or agreements made with the client..." oninput="autoExpand(this)"></textarea>
            </div>
        </div>

        <!-- Provisionals -->
        <div class="section">
            <div class="section-header">Provisionals</div>
            <div class="section-content">
                <table id="provisionalsTable">
                    <thead>
                        <tr>
                            <th style="width: 40%">Description</th>
                            <th style="width: 10%">Qty</th>
                            <th style="width: 15%">Unit Price</th>
                            <th style="width: 4%">Markup Inc.</th>
                            <th style="width: 4%">GST Inc.</th>
                            <th style="width: 23%">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="input-field" placeholder="Provisional item description"></td>
                            <td><input type="number" class="input-field" placeholder="1" min="0" onchange="calculateProvisionalsTotal(this)"></td>
                            <td><input type="number" class="input-field" step="0.01" placeholder="0.00" onchange="calculateProvisionalsTotal(this)"></td>
                            <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                            <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                            <td><input type="number" class="readonly-field" step="0.01" placeholder="0.00" readonly></td>
                        </tr>
                    </tbody>
                </table>
                <button class="add-button" onclick="addProvisionalsRow()">+ Add Provisional</button>
                <div class="subtotal-line">
                    Provisionals Subtotal: $<span id="provisionalsSubtotal">0.00</span>
                </div>
            </div>
        </div>

        <!-- Optional -->
        <div class="section">
            <div class="section-header">Optional Items</div>
            <div class="section-content">
                <table id="optionalTable">
                    <thead>
                        <tr>
                            <th style="width: 40%">Description</th>
                            <th style="width: 10%">Qty</th>
                            <th style="width: 15%">Unit Price</th>
                            <th style="width: 4%">Markup Inc.</th>
                            <th style="width: 4%">GST Inc.</th>
                            <th style="width: 23%">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><input type="text" class="input-field" placeholder="Optional item description"></td>
                            <td><input type="number" class="input-field" placeholder="1" min="0" onchange="calculateOptionalTotal(this)"></td>
                            <td><input type="number" class="input-field" step="0.01" placeholder="0.00" onchange="calculateOptionalTotal(this)"></td>
                            <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                            <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                            <td><input type="number" class="readonly-field" step="0.01" placeholder="0.00" readonly></td>
                        </tr>
                    </tbody>
                </table>
                <button class="add-button" onclick="addOptionalRow()">+ Add Optional</button>
                <div class="subtotal-line">
                    Optional Items Subtotal: $<span id="optionalSubtotal">0.00</span>
                </div>
            </div>
        </div>

        <!-- Totals -->
        <div class="total-section">
            <div class="total-row">
                <span>Materials Subtotal:</span>
                <span>$<span id="finalItemsSubtotal">0.00</span></span>
            </div>
            <div class="total-row">
                <span>Labour Cost:</span>
                <span>$<span id="finalLabourSubtotal">0.00</span></span>
            </div>
            <div class="total-row">
                <span>Provisionals:</span>
                <span>$<span id="finalProvisionalsSubtotal">0.00</span></span>
            </div>
            <div class="total-row">
                <span>Subtotal (exc. GST):</span>
                <span>$<span id="subtotalExcGST">0.00</span></span>
            </div>
            <div class="total-row">
                <span>GST (10%):</span>
                <span>$<span id="gstAmount">0.00</span></span>
            </div>
            <div class="total-row final-total">
                <span>TOTAL (inc. GST):</span>
                <span>$<span id="totalIncGST">0.00</span></span>
            </div>
        </div>

        <!-- Labour Totals -->
        <div class="total-section">
            <div class="total-row">
                <span>Normal Hours:</span>
                <span><span id="finalNormalHours">0.0</span> hrs ($<span id="finalNormalCost">0.00</span>)</span>
            </div>
            <div class="total-row">
                <span>Overtime Hours:</span>
                <span><span id="finalOvertimeHours">0.0</span> hrs ($<span id="finalOvertimeCost">0.00</span>)</span>
            </div>
            <div class="total-row final-total">
                <span>Total Hours:</span>
                <span><span id="finalTotalHours">0.0</span> hrs ($<span id="finalTotalLabourCost">0.00</span>)</span>
            </div>
        </div>

        <!-- Optional Items -->
        <div class="total-section">
            <div class="total-row final-total">
                <span>Optional Items Total:</span>
                <span>$<span id="finalOptionalSubtotal">0.00</span></span>
            </div>
        </div>

        <!-- Additional Notes -->
        <div class="section">
            <div class="section-header">Additional Notes & Conditions</div>
            <div class="section-content">
                <textarea class="notes-area" id="additionalNotes" placeholder="Terms and conditions, warranty information, completion timeframes, etc." oninput="autoExpand(this)"></textarea>
            </div>
        </div>

        <button class="action-button" onclick="printQuote()">Print Quote</button>
        <button class="action-button" onclick="shareScope()">Share Scope</button>
    </div>

    <script>
        function addItemRow() {
            const table = document.getElementById('itemsTable').getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();
            newRow.innerHTML = `
                <td><input type="text" class="input-field" placeholder="Item description"></td>
                <td><input type="number" class="input-field" placeholder="1" min="0" onchange="calculateItemTotal(this)"></td>
                <td><input type="number" class="input-field" step="0.01" placeholder="0.00" onchange="calculateItemTotal(this)"></td>
                <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                <td><input type="number" class="readonly-field" step="0.01" placeholder="0.00" readonly></td>
            `;
        }

        function addLabourRow() {
            const table = document.getElementById('labourTable').getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();
            newRow.innerHTML = `
                <td><input type="text" class="input-field" placeholder="Labour description"></td>
                <td><input type="number" class="input-field" step="0.5" placeholder="0.0" onchange="calculateLabourTotals()"></td>
                <td style="text-align: center;">
                    <input type="checkbox" class="checkbox-field" onchange="calculateLabourTotals()">
                </td>
                <td><textarea class="expanding-field" placeholder="" oninput="autoExpand(this)"></textarea></td>
            `;
        }

        function addProvisionalsRow() {
            const table = document.getElementById('provisionalsTable').getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();
            newRow.innerHTML = `
                <td><input type="text" class="input-field" placeholder="Provisional item description"></td>
                <td><input type="number" class="input-field" placeholder="1" min="0" onchange="calculateProvisionalsTotal(this)"></td>
                <td><input type="number" class="input-field" step="0.01" placeholder="0.00" onchange="calculateProvisionalsTotal(this)"></td>
                <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                <td><input type="number" class="readonly-field" step="0.01" placeholder="0.00" readonly></td>
            `;
        }

        function addOptionalRow() {
            const table = document.getElementById('optionalTable').getElementsByTagName('tbody')[0];
            const newRow = table.insertRow();
            newRow.innerHTML = `
                <td><input type="text" class="input-field" placeholder="Optional item description"></td>
                <td><input type="number" class="input-field" placeholder="1" min="0" onchange="calculateOptionalTotal(this)"></td>
                <td><input type="number" class="input-field" step="0.01" placeholder="0.00" onchange="calculateOptionalTotal(this)"></td>
                <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                <td style="text-align: center;"><input type="checkbox" class="checkbox-field"></td>
                <td><input type="number" class="readonly-field" step="0.01" placeholder="0.00" readonly></td>
            `;
        }

        function calculateItemTotal(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const price = parseFloat(row.cells[2].querySelector('input').value) || 0;
            const total = qty * price;
            row.cells[5].querySelector('input').value = total.toFixed(2);
            calculateItemsSubtotal();
            calculateTotals();
        }

        function calculateLabourTotals() {
            const table = document.getElementById('labourTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let totalHours = 0;
            let normalHours = 0;
            let overtimeHours = 0;
            
            const normalRate = parseFloat(document.getElementById('normalRate').value) || 0;
            const overtimeRate = parseFloat(document.getElementById('overtimeRate').value) || 0;
            
            for (let i = 0; i < rows.length; i++) {
                const hours = parseFloat(rows[i].cells[1].querySelector('input').value) || 0;
                const isOvertime = rows[i].cells[2].querySelector('input[type="checkbox"]').checked;
                
                totalHours += hours;
                if (isOvertime) {
                    overtimeHours += hours;
                } else {
                    normalHours += hours;
                }
            }
            
            const normalCost = normalHours * normalRate;
            const overtimeCost = overtimeHours * overtimeRate;
            const totalLabourCost = normalCost + overtimeCost;
            
            // Update labour section totals
            document.getElementById('totalHours').textContent = totalHours.toFixed(1);
            document.getElementById('normalHours').textContent = normalHours.toFixed(1);
            document.getElementById('overtimeHours').textContent = overtimeHours.toFixed(1);
            document.getElementById('normalCost').textContent = normalCost.toFixed(2);
            document.getElementById('overtimeCost').textContent = overtimeCost.toFixed(2);
            document.getElementById('labourSubtotal').textContent = totalLabourCost.toFixed(2);
            
            // Update final totals section
            document.getElementById('finalTotalHours').textContent = totalHours.toFixed(1);
            document.getElementById('finalNormalHours').textContent = normalHours.toFixed(1);
            document.getElementById('finalOvertimeHours').textContent = overtimeHours.toFixed(1);
            document.getElementById('finalNormalCost').textContent = normalCost.toFixed(2);
            document.getElementById('finalOvertimeCost').textContent = overtimeCost.toFixed(2);
            document.getElementById('finalTotalLabourCost').textContent = totalLabourCost.toFixed(2);
            document.getElementById('finalLabourSubtotal').textContent = totalLabourCost.toFixed(2);
            
            calculateTotals();
        }

        function calculateLabourSubtotal() {
            // Labour cost calculation would go here when rates are defined
            const labourSubtotal = 0;
            document.getElementById('labourSubtotal').textContent = labourSubtotal.toFixed(2);
            calculateTotals();
        }

        function calculateProvisionalsTotal(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const price = parseFloat(row.cells[2].querySelector('input').value) || 0;
            const total = qty * price;
            row.cells[5].querySelector('input').value = total.toFixed(2);
            calculateProvisionalsSubtotal();
            calculateTotals();
        }

        function calculateOptionalTotal(input) {
            const row = input.closest('tr');
            const qty = parseFloat(row.cells[1].querySelector('input').value) || 0;
            const price = parseFloat(row.cells[2].querySelector('input').value) || 0;
            const total = qty * price;
            row.cells[5].querySelector('input').value = total.toFixed(2);
            calculateOptionalSubtotal();
            calculateTotals();
        }

        function calculateProvisionalsSubtotal() {
            const table = document.getElementById('provisionalsTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let subtotal = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const total = parseFloat(rows[i].cells[5].querySelector('input').value) || 0;
                subtotal += total;
            }
            
            document.getElementById('provisionalsSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('finalProvisionalsSubtotal').textContent = subtotal.toFixed(2);
            calculateTotals();
        }

        function calculateOptionalSubtotal() {
            const table = document.getElementById('optionalTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let subtotal = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const total = parseFloat(rows[i].cells[5].querySelector('input').value) || 0;
                subtotal += total;
            }
            
            document.getElementById('optionalSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('finalOptionalSubtotal').textContent = subtotal.toFixed(2);
            calculateTotals();
        }

        function calculateItemsSubtotal() {
            const table = document.getElementById('itemsTable');
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let subtotal = 0;
            
            for (let i = 0; i < rows.length; i++) {
                const total = parseFloat(rows[i].cells[5].querySelector('input').value) || 0;
                subtotal += total;
            }
            
            document.getElementById('itemsSubtotal').textContent = subtotal.toFixed(2);
            document.getElementById('finalItemsSubtotal').textContent = subtotal.toFixed(2);
        }

        function calculateTotals() {
            const itemsSubtotal = parseFloat(document.getElementById('itemsSubtotal').textContent) || 0;
            const labourSubtotal = parseFloat(document.getElementById('labourSubtotal').textContent) || 0;
            const provisionalsSubtotal = parseFloat(document.getElementById('provisionalsSubtotal').textContent) || 0;
            
            const subtotalExcGST = itemsSubtotal + labourSubtotal + provisionalsSubtotal;
            const gstAmount = subtotalExcGST * 0.1;
            const totalIncGST = subtotalExcGST + gstAmount;
            
            document.getElementById('subtotalExcGST').textContent = subtotalExcGST.toFixed(2);
            document.getElementById('gstAmount').textContent = gstAmount.toFixed(2);
            document.getElementById('totalIncGST').textContent = totalIncGST.toFixed(2);
        }

        function generateFileName() {
            const jobName = document.getElementById('jobName').value.trim();
            const dueDate = document.getElementById('quoteDueDate').value;
            
            let fileName = '';
            
            if (jobName) {
                // Clean job name for filename (remove invalid characters)
                const cleanJobName = jobName.replace(/[<>:"/\\|?*]/g, '-');
                fileName += cleanJobName;
            } else {
                fileName += 'Scope_';
            }
            
            if (dueDate) {
                // Format date as DD-MM-YYYY
                const dateObj = new Date(dueDate);
                const day = String(dateObj.getDate()).padStart(2, '0');
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const year = dateObj.getFullYear();
                fileName += `_${day}-${month}-${year}`;
            } else {
                // Use current date if no due date
                const today = new Date();
                const day = String(today.getDate()).padStart(2, '0');
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const year = today.getFullYear();
                fileName += `_${day}-${month}-${year}`;
            }
            
            return fileName;
        }

        function updatePageTitle() {
            const fileName = generateFileName();
            document.getElementById('pageTitle').textContent = fileName;
            document.title = fileName;
        }

        function printQuote() {
            // Update page title for PDF filename
            updatePageTitle();
            
            // Pre-process text areas for printing with line-based calculation
            preprocessTextAreasForPrint();
            
            // Auto-save JSON file before printing
            setTimeout(() => {
                try {
                    const { url } = saveQuoteToFile();
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = generateFileName() + '.json';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    console.log('Auto-save completed before printing');
                } catch (error) {
                    console.error('Auto-save failed:', error);
                }
                
                // Print after auto-save attempt - increased delay to ensure height changes applied
                setTimeout(() => {
                    window.print();
                    
                    // Clean up after printing
                    setTimeout(() => {
                        cleanupAfterPrint();
                    }, 1000);
                }, 200); // Increased delay
            }, 100);
        }

        function preprocessTextAreasForPrint() {
            // Standard A4 page dimensions (accounting for margins)
            const pageHeight = 1000; // Approximate usable height in pixels
            const lineHeight = 16;
            
            const textareas = document.querySelectorAll('textarea, .notes-area, .expanding-field');
            
            textareas.forEach(textarea => {
                const text = textarea.value || '';
                if (!text.trim()) return;
                
                // Calculate current position on page
                const currentPagePosition = calculatePagePosition(textarea);
                const remainingPageSpace = pageHeight - (currentPagePosition % pageHeight);
                
                // Calculate total content height needed
                const totalLines = calculateTextLines(textarea, text);
                const totalHeight = totalLines * lineHeight + 16; // +16 for padding
                
                // If content exceeds remaining space, split it
                if (totalHeight > remainingPageSpace) {
                    splitTextAreaContent(textarea, text, remainingPageSpace, lineHeight);
                } else {
                    // Normal expansion
                    textarea.style.setProperty('height', totalHeight + 'px', 'important');
                }
            });
        }

        function calculatePagePosition(element) {
            let totalHeight = 0;
            let currentElement = element;
            
            // Walk up the DOM to calculate cumulative height
            while (currentElement && currentElement !== document.body) {
                const rect = currentElement.getBoundingClientRect();
                const style = window.getComputedStyle(currentElement);
                
                // Add element height and margins
                totalHeight += rect.height;
                totalHeight += parseInt(style.marginTop) || 0;
                totalHeight += parseInt(style.marginBottom) || 0;
                
                currentElement = currentElement.previousElementSibling || currentElement.parentElement;
            }
            
            return totalHeight;
        }

        function splitTextAreaContent(textarea, text, remainingSpace, lineHeight) {
            const linesPerPage = Math.floor(remainingSpace / lineHeight) - 2; // Buffer for padding
            const textLines = text.split('\n');
            
            // Calculate how many lines fit on current page
            let currentPageLines = 0;
            let lineIndex = 0;
            
            // Create container for split content
            const container = document.createElement('div');
            container.className = 'split-textarea-container';
            
            while (lineIndex < textLines.length) {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'split-textarea-page';
                pageDiv.style.cssText = `
                    border: 1px solid #000 !important;
                    padding: 8px !important;
                    background: white !important;
                    font-family: inherit !important;
                    font-size: 12px !important;
                    white-space: pre-wrap !important;
                    word-wrap: break-word !important;
                    margin-bottom: 0 !important;
                    page-break-inside: avoid !important;
                `;
                
                // Add lines to current page
                const pageLines = [];
                const maxLinesThisPage = (lineIndex === 0) ? linesPerPage : Math.floor(1000 / lineHeight) - 2;
                
                while (lineIndex < textLines.length && pageLines.length < maxLinesThisPage) {
                    pageLines.push(textLines[lineIndex]);
                    lineIndex++;
                }
                
                pageDiv.textContent = pageLines.join('\n');
                container.appendChild(pageDiv);
                
                // Force page break after each section except the last
                if (lineIndex < textLines.length) {
                    pageDiv.style.pageBreakAfter = 'always';
                }
            }
            
            // Replace original textarea with split content
            textarea.style.display = 'none';
            textarea.parentNode.insertBefore(container, textarea);
            
            // Store reference for cleanup
            textarea.dataset.splitContainer = 'true';
        }

        function calculateTextLines(textarea, text) {
            // Count explicit line breaks
            const explicitLines = (text.match(/\n/g) || []).length + 1;
            
            // Calculate wrapped lines
            const textareaWidth = textarea.offsetWidth;
            const computedStyle = window.getComputedStyle(textarea);
            const paddingLeft = parseInt(computedStyle.paddingLeft) || 8;
            const paddingRight = parseInt(computedStyle.paddingRight) || 8;
            const availableWidth = textareaWidth - paddingLeft - paddingRight;
            
            // Estimate character width (rough approximation)
            const fontSize = parseInt(computedStyle.fontSize) || 12;
            const avgCharWidth = fontSize * 0.6; // Rough estimate for average character width
            const charsPerLine = Math.floor(availableWidth / avgCharWidth);
            
            if (charsPerLine <= 0) return explicitLines; // Fallback
            
            // Split text by explicit line breaks, then calculate wrapped lines for each
            const textLines = text.split('\n');
            let totalWrappedLines = 0;
            
            textLines.forEach(line => {
                if (line.length === 0) {
                    totalWrappedLines += 1; // Empty line still takes space
                } else {
                    const wrappedLines = Math.ceil(line.length / charsPerLine);
                    totalWrappedLines += wrappedLines;
                }
            });
            
            // Return the larger of explicit lines or calculated wrapped lines
            return Math.max(explicitLines, totalWrappedLines);
        }

        function cleanupAfterPrint() {
            // Remove split containers
            const splitContainers = document.querySelectorAll('.split-textarea-container');
            splitContainers.forEach(container => container.remove());
            
            // Restore original textareas
            const textareas = document.querySelectorAll('textarea[data-split-container]');
            textareas.forEach(textarea => {
                textarea.style.display = '';
                delete textarea.dataset.splitContainer;
            });
            
            // Original cleanup code...
            const allTextareas = document.querySelectorAll('textarea, .notes-area, .expanding-field');
            allTextareas.forEach(textarea => {
                const originalHeight = textarea.dataset.originalHeight;
                if (originalHeight !== undefined) {
                    textarea.style.height = originalHeight;
                }
                textarea.style.removeProperty('min-height');
                textarea.style.removeProperty('max-height');
                textarea.style.removeProperty('overflow');
                delete textarea.dataset.originalHeight;
            });
        }

        function saveQuoteToFile() {
            const quoteData = {
                timestamp: new Date().toISOString(),
                jobName: document.getElementById('jobName').value,
                contactPerson: document.getElementById('contactPerson').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                quoteDueDate: document.getElementById('quoteDueDate').value,
                businessName: document.getElementById('businessName').value,
                businessAddress: {
                    street: document.getElementById('businessStreet').value,
                    suburb: document.getElementById('businessSuburb').value,
                    state: document.getElementById('businessState').value,
                    postcode: document.getElementById('businessPostcode').value,
                    country: document.getElementById('businessCountry').value
                },
                siteAddress: {
                    street: document.getElementById('siteStreet').value,
                    suburb: document.getElementById('siteSuburb').value,
                    state: document.getElementById('siteState').value,
                    postcode: document.getElementById('sitePostcode').value,
                    country: document.getElementById('siteCountry').value
                },
                scopeOfWork: document.getElementById('scopeOfWork').value,
                normalRate: parseFloat(document.getElementById('normalRate').value) || 0,
                overtimeRate: parseFloat(document.getElementById('overtimeRate').value) || 0,
                pricesDiscussed: document.getElementById('pricesDiscussed').value,
                additionalNotes: document.getElementById('additionalNotes').value,
                items: getTableData('itemsTable'),
                labour: getTableData('labourTable'),
                provisionals: getTableData('provisionalsTable'),
                optional: getTableData('optionalTable')
            };

            const jsonData = JSON.stringify(quoteData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            return { blob, url, data: quoteData };
        }

        function saveQuote() {
            try {
                const { url } = saveQuoteToFile();
                
                const a = document.createElement('a');
                a.href = url;
                a.download = generateFileName() + '.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                alert('Quote saved successfully!');
            } catch (error) {
                alert('Error saving quote. Please try again.');
                console.error('Save error:', error);
            }
        }

        function autoExpand(field) {
            field.style.height = 'inherit';
            const computed = window.getComputedStyle(field);
            const height = parseInt(computed.getPropertyValue('border-top-width'), 10)
                         + parseInt(computed.getPropertyValue('padding-top'), 10)
                         + field.scrollHeight
                         + parseInt(computed.getPropertyValue('padding-bottom'), 10)
                         + parseInt(computed.getPropertyValue('border-bottom-width'), 10);
            field.style.height = height + 'px';
        }

        function loadQuote(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const quoteData = JSON.parse(e.target.result);
                    
                    // Load basic fields
                    document.getElementById('jobName').value = quoteData.jobName || '';
                    document.getElementById('contactPerson').value = quoteData.contactPerson || '';
                    document.getElementById('phone').value = quoteData.phone || '';
                    document.getElementById('email').value = quoteData.email || '';
                    document.getElementById('quoteDueDate').value = quoteData.quoteDueDate || '';
                    document.getElementById('businessName').value = quoteData.businessName || '';
                    
                    // Load business address
                    if (quoteData.businessAddress) {
                        document.getElementById('businessStreet').value = quoteData.businessAddress.street || '';
                        document.getElementById('businessSuburb').value = quoteData.businessAddress.suburb || '';
                        document.getElementById('businessState').value = quoteData.businessAddress.state || '';
                        document.getElementById('businessPostcode').value = quoteData.businessAddress.postcode || '';
                        document.getElementById('businessCountry').value = quoteData.businessAddress.country || '';
                    }
                    
                    // Load site address
                    if (quoteData.siteAddress) {
                        document.getElementById('siteStreet').value = quoteData.siteAddress.street || '';
                        document.getElementById('siteSuburb').value = quoteData.siteAddress.suburb || '';
                        document.getElementById('siteState').value = quoteData.siteAddress.state || '';
                        document.getElementById('sitePostcode').value = quoteData.siteAddress.postcode || '';
                        document.getElementById('siteCountry').value = quoteData.siteAddress.country || '';
                    }
                    
                    document.getElementById('scopeOfWork').value = quoteData.scopeOfWork || '';
                    document.getElementById('normalRate').value = quoteData.normalRate || 75;
                    document.getElementById('overtimeRate').value = quoteData.overtimeRate || 150;
                    document.getElementById('pricesDiscussed').value = quoteData.pricesDiscussed || '';
                    document.getElementById('additionalNotes').value = quoteData.additionalNotes || '';
                    
                    // Load table data
                    if (quoteData.items) loadTableData('itemsTable', quoteData.items);
                    if (quoteData.labour) loadTableData('labourTable', quoteData.labour);
                    if (quoteData.provisionals) loadTableData('provisionalsTable', quoteData.provisionals);
                    if (quoteData.optional) loadTableData('optionalTable', quoteData.optional);
                    
                    // Recalculate totals
                    calculateItemsSubtotal();
                    calculateLabourTotals();
                    calculateProvisionalsSubtotal();
                    calculateOptionalSubtotal();
                    calculateTotals();
                    
                    alert('Quote loaded successfully!');
                } catch (error) {
                    alert('Error loading quote file. Please check the file format.');
                    console.error('Error parsing quote file:', error);
                }
            };
            reader.readAsText(file);
        }

        function getTableData(tableId) {
            const table = document.getElementById(tableId);
            const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            const data = [];
            
            for (let i = 0; i < rows.length; i++) {
                const rowData = {};
                const cells = rows[i].getElementsByTagName('td');
                
                for (let j = 0; j < cells.length; j++) {
                    const input = cells[j].querySelector('input[type="text"], input[type="number"]:not(.readonly-field)');
                    const checkbox = cells[j].querySelector('input[type="checkbox"]');
                    const textarea = cells[j].querySelector('textarea');
                    
                    if (checkbox) {
                        rowData[`col_${j}_checkbox`] = checkbox.checked;
                    } else if (input) {
                        rowData[`col_${j}_input`] = input.value;
                    } else if (textarea) {
                        rowData[`col_${j}_textarea`] = textarea.value;
                    }
                }
                data.push(rowData);
            }
            return data;
        }

        function loadTableData(tableId, data) {
            const table = document.getElementById(tableId);
            const tbody = table.getElementsByTagName('tbody')[0];
            
            // Clear existing rows except the first one
            while (tbody.rows.length > 1) {
                tbody.deleteRow(1);
            }
            
            // Load data into rows
            for (let i = 0; i < data.length; i++) {
                let row;
                if (i === 0) {
                    row = tbody.rows[0];
                } else {
                    // Add new row based on table type
                    if (tableId === 'itemsTable') addItemRow();
                    else if (tableId === 'labourTable') addLabourRow();
                    else if (tableId === 'provisionalsTable') addProvisionalsRow();
                    else if (tableId === 'optionalTable') addOptionalRow();
                    row = tbody.rows[tbody.rows.length - 1];
                }
                
                const cells = row.getElementsByTagName('td');
                const rowData = data[i];
                
                for (let j = 0; j < cells.length; j++) {
                    const input = cells[j].querySelector('input[type="text"], input[type="number"]:not(.readonly-field)');
                    const checkbox = cells[j].querySelector('input[type="checkbox"]');
                    const textarea = cells[j].querySelector('textarea');
                    
                    if (checkbox && rowData[`col_${j}_checkbox`] !== undefined) {
                        checkbox.checked = rowData[`col_${j}_checkbox`];
                    } else if (input && rowData[`col_${j}_input`] !== undefined) {
                        input.value = rowData[`col_${j}_input`];
                    } else if (textarea && rowData[`col_${j}_textarea`] !== undefined) {
                        textarea.value = rowData[`col_${j}_textarea`];
                        autoExpand(textarea);
                    }
                }
            }
            
            // Force recalculations after loading all data
            setTimeout(() => {
                calculateItemsSubtotal();
                calculateLabourTotals();
                calculateProvisionalsSubtotal();
                calculateOptionalSubtotal();
                calculateTotals();
            }, 50);
        }

        // Initialise calculations and add event listeners for dynamic title updates
        document.addEventListener('DOMContentLoaded', function() {
            calculateItemsSubtotal();
            calculateLabourTotals();
            calculateProvisionalsSubtotal();
            calculateOptionalSubtotal();
            calculateTotals();
            
            // Update page title when job name or due date changes
            const jobNameField = document.getElementById('jobName');
            const dueDateField = document.getElementById('quoteDueDate');
            
            jobNameField.addEventListener('input', updatePageTitle);
            dueDateField.addEventListener('change', updatePageTitle);
            
            // Set initial title
            updatePageTitle();
        });

        // Function to resize textarea based on content
        function resizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = textarea.scrollHeight + 'px';
        }

        // Attach the resize function to all textareas on input
        document.querySelectorAll('textarea').forEach(textarea => {
            textarea.addEventListener('input', () => resizeTextarea(textarea));
        });

function shareScope() {
            const jobName = document.getElementById('jobName').value || 'Electrical Works Quote';
            const contactPerson = document.getElementById('contactPerson').value;
            const phone = document.getElementById('phone').value;
            const email = document.getElementById('email').value;
            const quoteDueDate = document.getElementById('quoteDueDate').value;
            const businessName = document.getElementById('businessName').value;
            const scopeOfWork = document.getElementById('scopeOfWork').value;
            const pricesDiscussed = document.getElementById('pricesDiscussed').value;
            const additionalNotes = document.getElementById('additionalNotes').value;
            
            // Format date
            let dueDateText = '';
            if (quoteDueDate) {
                const dateObj = new Date(quoteDueDate);
                dueDateText = dateObj.toLocaleDateString('en-AU');
            }
            
            // Build address strings
            let businessAddress = '';
            const businessStreet = document.getElementById('businessStreet').value;
            const businessSuburb = document.getElementById('businessSuburb').value;
            const businessState = document.getElementById('businessState').value;
            const businessPostcode = document.getElementById('businessPostcode').value;
            
            if (businessStreet || businessSuburb || businessState || businessPostcode) {
                businessAddress = [businessStreet, businessSuburb, businessState, businessPostcode].filter(Boolean).join(', ');
            }
            
            let siteAddress = '';
            const siteStreet = document.getElementById('siteStreet').value;
            const siteSuburb = document.getElementById('siteSuburb').value;
            const siteState = document.getElementById('siteState').value;
            const sitePostcode = document.getElementById('sitePostcode').value;
            
            if (siteStreet || siteSuburb || siteState || sitePostcode) {
                siteAddress = [siteStreet, siteSuburb, siteState, sitePostcode].filter(Boolean).join(', ');
            }
            
            // Get totals
            const totalIncGST = document.getElementById('totalIncGST').textContent;
            const totalHours = document.getElementById('finalTotalHours').textContent;
            
            // Build email content
            let emailBody = `CINC WHELAN ELECTRICAL - SCOPE OF WORK\n`;
            emailBody += `=======================================\n\n`;
            
            if (jobName) emailBody += `JOB: ${jobName}\n`;
            if (dueDateText) emailBody += `DUE DATE: ${dueDateText}\n`;
            emailBody += `\n`;
            
            if (contactPerson || businessName || phone || email) {
                emailBody += `CLIENT DETAILS:\n`;
                emailBody += `---------------\n`;
                if (contactPerson) emailBody += `Contact: ${contactPerson}\n`;
                if (businessName) emailBody += `Company: ${businessName}\n`;
                if (phone) emailBody += `Phone: ${phone}\n`;
                if (email) emailBody += `Email: ${email}\n`;
                if (businessAddress) emailBody += `Address: ${businessAddress}\n`;
                emailBody += `\n`;
            }
            
            if (siteAddress) {
                emailBody += `SITE ADDRESS:\n`;
                emailBody += `-------------\n`;
                emailBody += `${siteAddress}\n\n`;
            }
            
            if (scopeOfWork) {
                emailBody += `SCOPE OF WORK:\n`;
                emailBody += `--------------\n`;
                emailBody += `${scopeOfWork}\n\n`;
            }
            
            // Add items summary
            const itemsTable = document.getElementById('itemsTable');
            const itemRows = itemsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let hasItems = false;
            
            for (let i = 0; i < itemRows.length; i++) {
                const desc = itemRows[i].cells[0].querySelector('input').value;
                if (desc.trim()) {
                    if (!hasItems) {
                        emailBody += `MATERIALS & ITEMS:\n`;
                        emailBody += `------------------\n`;
                        hasItems = true;
                    }
                    const qty = itemRows[i].cells[1].querySelector('input').value || '1';
                    const price = itemRows[i].cells[2].querySelector('input').value || '0';
                    emailBody += `• ${desc} (Qty: ${qty}, $${price})\n`;
                }
            }
            if (hasItems) emailBody += `\n`;
            
            // Add labour summary
            const labourTable = document.getElementById('labourTable');
            const labourRows = labourTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let hasLabour = false;
            
            for (let i = 0; i < labourRows.length; i++) {
                const desc = labourRows[i].cells[0].querySelector('input').value;
                if (desc.trim()) {
                    if (!hasLabour) {
                        emailBody += `LABOUR:\n`;
                        emailBody += `-------\n`;
                        hasLabour = true;
                    }
                    const hours = labourRows[i].cells[1].querySelector('input').value || '0';
                    const isOvertime = labourRows[i].cells[2].querySelector('input[type="checkbox"]').checked;
                    const notes = labourRows[i].cells[3].querySelector('textarea').value;
                    emailBody += `• ${desc} (${hours} hrs${isOvertime ? ' - Overtime' : ''})`;
                    if (notes) emailBody += ` - ${notes}`;
                    emailBody += `\n`;
                }
            }
            if (hasLabour) emailBody += `\n`;
            
            // Add provisionals summary
            const provisionalsTable = document.getElementById('provisionalsTable');
            const provisionalsRows = provisionalsTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let hasProvisionals = false;
            
            for (let i = 0; i < provisionalsRows.length; i++) {
                const desc = provisionalsRows[i].cells[0].querySelector('input').value;
                if (desc.trim()) {
                    if (!hasProvisionals) {
                        emailBody += `PROVISIONALS:\n`;
                        emailBody += `-------------\n`;
                        hasProvisionals = true;
                    }
                    const qty = provisionalsRows[i].cells[1].querySelector('input').value || '1';
                    const price = provisionalsRows[i].cells[2].querySelector('input').value || '0';
                    emailBody += `• ${desc} (Qty: ${qty}, $${price})\n`;
                }
            }
            if (hasProvisionals) emailBody += `\n`;
            
            // Add optional items summary
            const optionalTable = document.getElementById('optionalTable');
            const optionalRows = optionalTable.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
            let hasOptional = false;
            
            for (let i = 0; i < optionalRows.length; i++) {
                const desc = optionalRows[i].cells[0].querySelector('input').value;
                if (desc.trim()) {
                    if (!hasOptional) {
                        emailBody += `OPTIONAL ITEMS:\n`;
                        emailBody += `---------------\n`;
                        hasOptional = true;
                    }
                    const qty = optionalRows[i].cells[1].querySelector('input').value || '1';
                    const price = optionalRows[i].cells[2].querySelector('input').value || '0';
                    emailBody += `• ${desc} (Qty: ${qty}, $${price})\n`;
                }
            }
            if (hasOptional) emailBody += `\n`;
            
            if (pricesDiscussed) {
                emailBody += `NOTES ON LABOUR & EQUIPMENT:\n`;
                emailBody += `-----------------------------\n`;
                emailBody += `${pricesDiscussed}\n\n`;
            }
            
            // Add totals
            emailBody += `ESTIMATE:\n`;
            emailBody += `---------\n`;
            if (totalHours !== '0.0') emailBody += `Total Hours: ${totalHours} hrs\n`;
            emailBody += `Total Cost: $${totalIncGST} (inc. GST)\n\n`;
            
            if (additionalNotes) {
                emailBody += `ADDITIONAL NOTES:\n`;
                emailBody += `-----------------\n`;
                emailBody += `${additionalNotes}\n\n`;
            }
            
            emailBody += `\nCINC Whelan Electrical\n\n\n`;
            
            // Create email subject
            let emailSubject = `Scope: ${jobName}`;
            if (dueDateText) {
                emailSubject += ` - Due ${dueDateText}`;
            }
            

            // console.log('Email Subject:', emailSubject);
            // alert('Subject will be: ' + emailSubject);
            
            // Open email
            const mailtoLink = `mailto:?subject=${encodeURIComponent(emailSubject)}&body=${encodeURIComponent(emailBody)}`;
            
            if (navigator.share) {
                // Try native share first (mobile)
                navigator.share({
                    title: emailSubject,
                    text: emailBody
                }).catch(() => {
                    // Fallback to mailto
                    window.open(mailtoLink) || (window.location.href = mailtoLink);
                });
            } else {
                // Desktop: open email client
                window.open(mailtoLink) || (window.location.href = mailtoLink);
            }
        }

    </script>
    
</body>
</html>
